# Pixel War: Crossfire (交叉火力) - 双机对战模式设计文档

## 1. 核心架构与物理设定

*   **硬件连接**：使用 ESP-NOW 进行两台 ESP32-S3 设备之间的点对点 (P2P) 无线通信。
*   **物理布局**：两台设备独立运行，不需要将两根 3 米长的灯带物理连接。两名玩家可以面对面、并排或背对背站立，每人拥有自己独立的 3 米灯带（战场）。
*   **通信协议**：交换游戏事件（连接、准备、发送攻击、死亡）。不需要高频同步所有实体状态。

## 2. 基础玩法与防线

*   **单机战场**：每条灯带的远端 (SPAWN_POS) 是敌方生成点，近端 (PLAYER_POS) 是玩家阵地。
*   **存活目标**：消灭移动过来的敌人。任何一个敌人（无论是系统生成的，还是对手发送的）触碰到底线 (PLAYER_POS 0)，该玩家立即判负（Game Over）。另一方判断为胜利 (Victory)。
*   **操作方式**：按下与敌人颜色（红、绿、蓝）相同的按键发射子弹。子弹与同色敌人相撞则双双抵消。

## 3. 核心机制：连击与惩罚系统 (Combo & Punish)

为了避免 1:1 发送怪物导致屏幕瞬间爆满，采用**“连打奖励”**机制。

### 3.1 连击 (Combo) 判定
*   玩家在短时间内（例如 2.5 秒内）连续正确消除 3 个敌人，达成一次 **Combo (连击)**。
*   单次消除只增加分数，**不会**给对手发送任何攻击。

### 3.2 惩罚发送 (Attack)
*   达成一次 Combo 时，系统通过 ESP-NOW 给对手发送一个 `MSG_ATTACK` 包。
*   接收到攻击包的设备，会在其灯带远端**强制插入一个额外的敌人**（或者一个特定颜色的“幽灵怪”）。

## 4. 特殊事件：白色炸弹抢夺 (The White Bomb)

增加随机的激烈对抗点，打破僵局。

*   **生成机制**：游戏每进行一段时间（如每 15 秒），系统会尽量在双方灯带中间位置同时生成一个闪烁的**白色怪物 (炸弹)**。
*   **触发方式**：白色炸弹可以使用任意颜色的按键（或者同时按下两个键）来消除。
*   **抢夺收益**：
    *   首先击毙白球的玩家：获得**清屏奖励**（消灭自己屏幕前半段的所有普通怪物）。
    *   同时，系统向对手发送**“强力攻击”**（对手屏幕立刻刷出 3 个移速极快的报复性怪物）。

## 5. 难度曲线与速度同步 (Time-Based Synchronization)

**这是保证公平性的核心。** 速度不与分数挂钩，而是与**这局游戏存活的时间**挂钩。

*   **起跑线同步**：两台设备通过 `MSG_READY` 握手后，同时记录 `battleStartTime`。
*   **时间决定速度**：
    *   例如，基础移动间隔是 150ms。
    *   公式：`当前移动间隔 = 150 - (游戏已进行秒数 / 10) * 10 ms`
    *   每存活 10 秒，怪物的移动速度自动变快一档。
    *   最低移动间隔锁定在 10ms（或 20ms）。
*   **异种怪的差异化速度**：
    *   **普通怪 (系统波次)**：按照当前的全局移动间隔前进（如现在是 100ms/格）。
    *   **惩罚怪 (对手连击/炸弹发来)**：可以分配更高的速度系数（如普通怪速度的 1.5 倍），即使在游戏前期也能保持高压。

## 6. 用户界面与状态

*   **配对模式 (STATE_PAIRING)**：
    *   待机界面下，玩家长按组合键（如 **红+绿** 3秒）进入配对模式。
    *   灯带显示蓝色呼吸灯，开始广播/扫描寻找另一个在配对模式的设备。
    *   配对成功后，双方短震动并亮起绿色灯效，倒计时 3-2-1。
*   **对战进行中 (STATE_BATTLE)**：复用已有的播放逻辑，加入网络数据的发送和接收处理。
*   **胜利/失败判定 (STATE_GAME_OVER)**：
    *   当一方被攻破防线时，播放红白爆闪和失败音效，同时向对手发送 `MSG_GAME_OVER`。
    *   对手收到 `MSG_GAME_OVER`，立刻停止刷怪，屏幕播放彩虹灯效和 1-UP 升级音效（胜利）。

## 7. ESP-NOW 通信包定义 (预计)

```cpp
enum PacketType {
  MSG_HELLO,      // 用于配对和握手
  MSG_READY,      // 准备完毕，倒计时开始
  MSG_ATTACK,     // 发送普通连击怪
  MSG_BOMB,       // 发送炸弹炸弹怪
  MSG_GAME_OVER   // 宣告自己死亡
};

typedef struct struct_message {
  uint8_t type;    // PacketType
  uint8_t color;   // 攻击的颜色/怪物的类型
  uint16_t delay;  // 预留，可以传递对面的时间戳做校验
} struct_message;
```

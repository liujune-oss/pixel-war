<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel War Control</title>

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0A0A0A">

    <!-- iOS Support -->
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pixel War">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Manrope:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-color: #0A0A0A;
            --surface: #18181B;
            --surface-hover: #27272A;
            --surface-pressed: #3F3F46;

            --text-primary: #FFFFFF;
            --text-secondary: #A1A1AA;
            --text-muted: #71717A;

            --primary: #C4F82A;
            --primary-dim: rgba(196, 248, 42, 0.1);
            --primary-hover: #D4FF4D;
            --primary-pressed: #A3E635;

            --danger: #EF4444;
            --danger-dim: rgba(239, 68, 68, 0.1);
            --warning: #EAB308;

            --border: #27272A;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.5;
            height: 100vh;
            height: 100dvh;
            display: flex;
            justify-content: center;
            background-image: radial-gradient(circle at 50% 0%, rgba(196, 248, 42, 0.05) 0%, transparent 50%);
        }

        #app {
            width: 100%;
            max-width: 480px;
            height: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .font-grotesk {
            font-family: 'Space Grotesk', sans-serif;
        }

        .font-mono {
            font-family: 'Space Mono', monospace;
        }

        h1,
        h2,
        h3 {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
        }

        /* Screen Management */
        .screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
            padding: 0 24px;
        }

        .screen.active {
            opacity: 1;
            pointer-events: auto;
            visibility: visible;
            z-index: 10;
        }

        /* Typography & General */
        .title {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .text-primary {
            color: var(--primary);
        }

        .text-white {
            color: var(--text-primary);
        }

        .text-yellow {
            color: var(--warning);
        }

        .text-dark {
            color: var(--bg-color);
        }

        .bg-primary {
            background-color: var(--primary);
        }

        .bg-surface {
            background-color: var(--surface);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-radius: 16px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            height: 56px;
        }

        .btn-large {
            height: 56px;
            width: 100%;
            font-size: 18px;
        }

        .btn-full {
            width: 100%;
        }

        .btn-half {
            flex: 1;
        }

        .btn-primary {
            background: linear-gradient(90deg, #C4F82A 0%, #A3E635 100%);
            color: var(--bg-color);
            box-shadow: 0 4px 24px rgba(196, 248, 42, 0.25);
        }

        .btn-primary:active {
            opacity: 0.8;
            transform: scale(0.98);
        }

        .btn-surface {
            background-color: var(--border);
            color: var(--text-primary);
        }

        .btn-danger-outline {
            background-color: var(--danger-dim);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: var(--danger);
        }

        .btn-danger-text {
            background: transparent;
            color: var(--danger);
        }

        .btn-icon-small {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background-color: var(--surface-hover);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        /* Connect Screen */
        #connectScreen {
            padding: 60px 40px;
            justify-content: space-between;
            align-items: center;
        }

        .header-center {
            text-align: center;
        }

        .header-center .title {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .header-center .subtitle {
            font-size: 16px;
        }

        .ble-center {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .ring {
            position: absolute;
            border-radius: 50%;
            animation: ripple 3s linear infinite;
        }

        .ring3 {
            width: 200px;
            height: 200px;
            border: 1px solid var(--border);
        }

        .ring2 {
            width: 140px;
            height: 140px;
            border: 1.5px solid var(--surface-pressed);
            animation-delay: 1s;
        }

        .ring1 {
            width: 80px;
            height: 80px;
            border: 2px solid rgba(196, 248, 42, 0.25);
            animation-delay: 2s;
        }

        .ble-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(180deg, #C4F82A 0%, #87D918 100%);
            box-shadow: 0 0 40px rgba(196, 248, 42, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
        }

        .ble-text {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: bold;
            font-size: 16px;
            color: var(--bg-color);
        }

        .status-text {
            color: var(--text-muted);
            font-size: 16px;
        }

        .action-area {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .helper-text {
            color: var(--text-muted);
            font-size: 13px;
            text-align: center;
        }

        @keyframes ripple {
            0% {
                transform: scale(0.8);
                opacity: 0.8;
            }

            100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }

        /* Dashboard & Settings Shared */
        .app-header {
            padding: 60px 0 16px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .status-badge {
            height: 44px;
            padding: 0 16px;
            border-radius: 22px;
            background-color: var(--surface);
            display: flex;
            align-items: center;
            border: 1px solid var(--border);
        }

        .badge-text {
            font-size: 13px;
            font-weight: 700;
        }

        .content-scroll {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 120px;
            /* Space for tab bar */
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .content-scroll::-webkit-scrollbar {
            width: 0;
        }

        .section-title {
            font-size: 20px;
            margin-bottom: 16px;
        }

        /* Cards */
        .metrics-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .metric-card {
            flex: 1;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
        }

        .metric-label {
            font-size: 14px;
            font-weight: 700;
            opacity: 0.8;
        }

        .difficulty-bar {
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .diff-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 700;
        }

        .diff-value {
            font-size: 13px;
        }

        .device-card {
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .card-padded {
            gap: 20px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .data-value {
            font-size: 14px;
            font-weight: 700;
        }

        .commands-stack {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .commands-row {
            display: flex;
            gap: 12px;
        }

        /* Form Controls */
        .control-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .custom-slider {
            -webkit-appearance: none;
            appearance: none;
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: var(--surface-pressed);
            outline: none;
        }

        .custom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
        }

        .slider-primary::-webkit-slider-thumb {
            background: var(--primary);
        }

        .slider-yellow::-webkit-slider-thumb {
            background: var(--warning);
        }

        /* Helper margins */
        .mt-4 {
            margin-top: 16px;
        }

        .mt-8 {
            margin-top: 32px;
        }

        /* Tab Bar */
        .tab-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 24px 32px 24px;
            background: linear-gradient(to top, var(--bg-color) 60%, transparent);
            display: flex;
            justify-content: center;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .tab-bar.hidden {
            transform: translateY(100%);
        }

        .tab-pill {
            background-color: var(--surface);
            height: 60px;
            border-radius: 30px;
            display: flex;
            padding: 4px;
            width: 200px;
            border: 1px solid var(--border);
        }

        .tab-btn {
            flex: 1;
            border-radius: 26px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
        }

        .tab-icon {
            width: 20px;
            height: 20px;
        }

        .tab-text {
            font-size: 11px;
            font-family: 'Space Grotesk', sans-serif;
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- Connect Screen -->
        <div id="connectScreen" class="screen active">
            <div class="header-center">
                <h1 class="title">Pixel War</h1>
                <p class="subtitle">ESP32-S3 管理面板 <span id="appVersionDisplayConnect" class="text-secondary font-mono"
                        style="font-size: 11px; margin-left: 8px;"></span></p>
            </div>

            <div class="ble-center">
                <div class="ring ring3"></div>
                <div class="ring ring2"></div>
                <div class="ring ring1"></div>
                <div class="ble-circle">
                    <span class="ble-text">BLE</span>
                </div>
            </div>

            <p id="connectionStatusText" class="status-text">搜索 Pixel War 设备...</p>

            <div class="action-area">
                <button id="btnConnect" class="btn btn-primary btn-large">
                    <i data-lucide="bluetooth" class="btn-icon"></i>
                    <span>搜索并连接</span>
                </button>
                <p class="helper-text">请确认您的设备电源已开启。</p>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboardScreen" class="screen">
            <header class="app-header">
                <div>
                    <h1 class="title">Pixel War</h1>
                    <p class="subtitle">ESP32-S3 控制台</p>
                </div>
            </header>

            <main class="content-scroll">
                <!-- Active Game Section -->
                <section class="card-section">
                    <h2 class="section-title">当前运行游戏</h2>
                    <div class="device-card bg-surface"
                        style="border: 1px solid var(--primary); background: linear-gradient(145deg, rgba(196,248,42,0.05) 0%, rgba(24,24,27,1) 100%);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div class="bg-primary" style="width: 8px; height: 32px; border-radius: 4px;"></div>
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--text-primary);"
                                id="activeGameTitle">光线消消乐</h3>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;" id="activeGameDesc">
                            按颜色消除向你逼近的敌人。
                        </p>
                    </div>
                </section>

                <!-- Overview Section -->
                <section class="card-section mt-4">
                    <h2 class="section-title">比赛概况</h2>
                    <div class="metrics-row">
                        <div class="metric-card bg-primary text-dark">
                            <div class="metric-value font-grotesk" id="scoreValue">0</div>
                            <div class="metric-label">总得分</div>
                        </div>
                        <div class="metric-card bg-surface">
                            <div class="metric-value font-grotesk text-white" id="killsValue">0</div>
                            <div class="metric-label">击杀数</div>
                        </div>
                    </div>
                    <div class="difficulty-bar">
                        <span class="diff-label">当前等级</span>
                        <span class="diff-value font-mono text-yellow" id="currentLevelValue">等级 1</span>
                    </div>
                </section>

                <!-- Device Section -->
                <section class="card-section">
                    <h2 class="section-title">在线设备</h2>
                    <div class="device-card bg-surface">
                        <div class="data-row">
                            <span class="data-label">连接状态</span>
                            <span class="data-value font-mono text-primary" id="bleStatus">已连接</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">当前电量</span>
                            <span class="data-value font-mono text-white" id="batteryValue">--%</span>
                        </div>
                    </div>
                </section>

                <!-- Commands Section -->
                <section class="card-section">
                    <h2 class="section-title">指令操作</h2>
                    <div class="commands-stack">
                        <button id="btnRestartGame" class="btn btn-primary btn-full">
                            <span>重开游戏</span>
                        </button>
                        <div class="commands-row">
                            <button id="btnStopGame" class="btn btn-danger-outline btn-half">
                                <span>暂停游戏</span>
                            </button>
                            <button id="btnRunDemo" class="btn btn-surface btn-half">
                                <span>运行演示</span>
                            </button>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="screen">
            <header class="app-header">
                <div>
                    <h1 class="title">Pixel War</h1>
                    <p class="subtitle">设备管理控制台 <span id="appVersionDisplay" class="text-secondary font-mono"
                            style="font-size: 11px; margin-left: 8px;"></span></p>
                </div>
            </header>

            <main class="content-scroll">
                <!-- System Status -->
                <section class="card-section">
                    <h2 class="section-title">系统状态</h2>
                    <div class="device-card bg-surface">
                        <div class="data-row">
                            <span class="data-label">固件版本</span>
                            <span class="data-value font-mono text-white" id="fwVersion">v1.2.0</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">剩余电量</span>
                            <span class="data-value font-mono text-primary" id="settingsBatteryValue">--%</span>
                        </div>
                    </div>
                </section>

                <!-- Configuration -->
                <section class="card-section">
                    <h2 class="section-title">控制器参数</h2>
                    <div class="device-card bg-surface card-padded">

                        <!-- LED Brightness -->
                        <div class="control-row">
                            <div class="control-header">
                                <span class="data-label">LED 显示亮度</span>
                                <span class="data-value font-mono text-primary" id="brightnessValue">80%</span>
                            </div>
                            <div class="slider-container">
                                <button class="btn-icon-small" id="btnBrightnessMinus"><i
                                        data-lucide="minus"></i></button>
                                <input type="range" id="brightnessSlider" class="custom-slider slider-primary" min="5"
                                    max="100" value="80">
                                <button class="btn-icon-small" id="btnBrightnessPlus"><i
                                        data-lucide="plus"></i></button>
                            </div>
                        </div>

                        <!-- Audio Volume -->
                        <div class="control-row mt-4">
                            <div class="control-header">
                                <span class="data-label">音频播放音量</span>
                                <span class="data-value font-mono text-primary" id="volumeValue">50%</span>
                            </div>
                            <div class="slider-container">
                                <button class="btn-icon-small" id="btnVolumeMinus"><i data-lucide="minus"></i></button>
                                <input type="range" id="volumeSlider" class="custom-slider slider-primary" min="0"
                                    max="10" value="5">
                                <button class="btn-icon-small" id="btnVolumePlus"><i data-lucide="plus"></i></button>
                            </div>
                        </div>

                        <!-- Game Difficulty -->
                        <div class="control-row mt-4">
                            <div class="control-header">
                                <span class="data-label">基础游戏难度</span>
                                <span class="data-value font-mono text-yellow" id="difficultyLevelStr">中等</span>
                            </div>
                            <div class="slider-container">
                                <input type="range" id="difficultySlider" class="custom-slider slider-yellow" min="1"
                                    max="14" value="5">
                            </div>
                        </div>

                    </div>
                </section>

                <!-- Danger Zone -->
                <section class="card-section mt-8">
                    <button id="btnEnterOTA" class="btn btn-surface btn-full mb-4" style="color: var(--warning);">
                        <i data-lucide="wifi" class="btn-icon"></i>
                        <span>进入 OTA 升级模式</span>
                    </button>
                    <button id="btnDisconnect" class="btn btn-danger-text btn-full">
                        <span>断开蓝牙连接</span>
                    </button>
                </section>
            </main>
        </div>

        <!-- Games Library Screen -->
        <div id="gamesScreen" class="screen">
            <header class="app-header">
                <div>
                    <h1 class="title">游戏引擎</h1>
                    <p class="subtitle">选择你想启动的游戏</p>
                </div>
            </header>

            <main class="content-scroll pb-24">
                <!-- Game 1: Light Beam -->
                <section class="card-section">
                    <div class="device-card bg-surface game-card" data-mode="0">
                        <div
                            style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                            <div>
                                <h3
                                    style="font-size: 20px; font-weight: 700; color: var(--primary); margin-bottom: 4px;">
                                    光线消消乐</h3>
                                <p style="color: var(--text-secondary); font-size: 13px;">Light Beam Elimination</p>
                            </div>
                            <i data-lucide="zap" style="color: var(--primary);"></i>
                        </div>
                        <p
                            style="color: var(--text-secondary); font-size: 14px; line-height: 1.5; margin-bottom: 20px;">
                            按颜色消除向你逼近的敌人，撑到最后即可过关。
                        </p>
                        <button class="btn btn-primary btn-full launch-btn" data-mode="0">
                            <i data-lucide="play" class="btn-icon"></i>
                            <span class="launch-btn-text">运行中</span>
                        </button>
                    </div>
                </section>

                <!-- Game 2: Snake (Coming Soon) -->
                <section class="card-section mt-4">
                    <div class="device-card bg-surface" style="opacity: 0.5;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                            <div>
                                <h3
                                    style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">
                                    贪吃蛇 (敬请期待)</h3>
                                <p style="color: var(--text-secondary); font-size: 13px;">Classic Snake</p>
                            </div>
                            <i data-lucide="clock" style="color: var(--text-secondary);"></i>
                        </div>
                        <p
                            style="color: var(--text-secondary); font-size: 14px; line-height: 1.5; margin-bottom: 20px;">
                            经典的贪吃蛇游戏，即将通过 OTA 更新加入！
                        </p>
                        <button class="btn btn-surface btn-full" disabled>
                            <span>未解锁</span>
                        </button>
                    </div>
                </section>
            </main>
        </div>

        <!-- Tab Bar -->
        <nav id="tabBar" class="tab-bar hidden">
            <div class="tab-pill">
                <button class="tab-btn active" data-target="dashboardScreen">
                    <i data-lucide="home" class="tab-icon"></i>
                    <span class="tab-text">首页</span>
                </button>
                <button class="tab-btn" data-target="gamesScreen">
                    <i data-lucide="gamepad-2" class="tab-icon"></i>
                    <span class="tab-text">游戏库</span>
                </button>
                <button class="tab-btn" data-target="settingsScreen">
                    <i data-lucide="settings" class="tab-icon"></i>
                    <span class="tab-text">设置</span>
                </button>
            </div>
        </nav>
    </div>

    <script>
        // ==========================================
        // 全局配置区 - 方便修改APP信息
        // ==========================================
        const APP_CONFIG = {
            version: "v1.2.0", // 修改此处的字符串即可更新网页显示的版本号
        };

        // DOM Elements
        const connectScreen = document.getElementById('connectScreen');
        const dashboardScreen = document.getElementById('dashboardScreen');
        const gamesScreen = document.getElementById('gamesScreen');
        const settingsScreen = document.getElementById('settingsScreen');
        const tabBar = document.getElementById('tabBar');
        const btnConnect = document.getElementById('btnConnect');
        const statusText = document.getElementById('connectionStatusText');

        // ==========================================
        // BLE 配置与状态
        // ==========================================
        const BLE_SERVICE_UUID = "7a0247cb-0000-48a8-b611-3957ce9fb6a4";
        const BLE_TX_UUID = "7a0247cb-0001-48a8-b611-3957ce9fb6a4";
        const BLE_RX_UUID = "7a0247cb-0002-48a8-b611-3957ce9fb6a4";

        let bleDevice = null;
        let bleServer = null;
        let bleService = null;
        let rxCharacteristic = null;
        let txCharacteristic = null;
        let isConnected = false;

        // Initialize app
        function init() {
            // 注入版本号
            document.getElementById('appVersionDisplay').textContent = APP_CONFIG.version;
            document.getElementById('appVersionDisplayConnect').textContent = APP_CONFIG.version;

            setupEventListeners();
            updateMockData();
        }

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.dataset.target;
                    switchTab(targetId, e.currentTarget);
                });
            });

            // Game Library launch buttons
            document.querySelectorAll('.launch-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const mode = e.currentTarget.dataset.mode;
                    sendDataToESP32('MODE:' + mode);
                    updateActiveGameUI(parseInt(mode));

                    // Switch back to dashboard implicitly via UI click simulation
                    const dashBtn = document.querySelector('[data-target="dashboardScreen"]');
                    switchTab('dashboardScreen', dashBtn);
                });
            });

            // Connection flow
            btnConnect.addEventListener('click', async () => {
                if (!navigator.bluetooth) {
                    alert('很抱歉，当前浏览器不支持 Web Bluetooth API。请使用 Chrome (PC/Android) 或 Bluefy (iOS)。');
                    return;
                }

                try {
                    statusText.textContent = "请求蓝牙访问权限...";
                    bleDevice = await navigator.bluetooth.requestDevice({
                        filters: [{ namePrefix: 'Pixel War' }],
                        optionalServices: [BLE_SERVICE_UUID]
                    });

                    bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

                    statusText.textContent = "正在连接设备...";
                    bleServer = await bleDevice.gatt.connect();

                    statusText.textContent = "获取服务与通道...";
                    bleService = await bleServer.getPrimaryService(BLE_SERVICE_UUID);

                    txCharacteristic = await bleService.getCharacteristic(BLE_TX_UUID);
                    rxCharacteristic = await bleService.getCharacteristic(BLE_RX_UUID);

                    // 开启收包监听
                    await txCharacteristic.startNotifications();
                    txCharacteristic.addEventListener('characteristicvaluechanged', handleIncomingData);

                    isConnected = true;
                    statusText.textContent = "连接成功！";

                    // 向单片机请求当前保存的系统设置
                    setTimeout(() => {
                        sendDataToESP32('SYNC');
                    }, 500);

                    setTimeout(() => {
                        showApp();
                    }, 800);

                } catch (error) {
                    console.error('Bluetooth Error:', error);
                    statusText.textContent = "连接失败: " + error.message;
                    if (bleDevice && bleDevice.gatt.connected) {
                        bleDevice.gatt.disconnect();
                    }
                }
            });

            // Device commands log
            document.getElementById('btnRestartGame').addEventListener('click', () => sendDataToESP32('RESTART'));
            document.getElementById('btnStopGame').addEventListener('click', () => sendDataToESP32('PAUSE'));
            document.getElementById('btnRunDemo').addEventListener('click', () => sendDataToESP32('DEMO'));
            document.getElementById('btnEnterOTA').addEventListener('click', () => {
                if (confirm("确定要让设备重启进入 OTA 无线升级模式吗？\n\n设备将断开蓝牙连拉并建立 WiFi 热点。")) {
                    sendDataToESP32('OTA');
                }
            });
            document.getElementById('btnDisconnect').addEventListener('click', () => {
                if (bleDevice && bleDevice.gatt.connected) {
                    bleDevice.gatt.disconnect();
                } else {
                    onDisconnected(); // Force UI update
                }
            });

            // Sliders (Update UI visually, and send command to ESP32 on release)
            setupSlider('brightnessSlider', 'brightnessValue', '%', null, (val) => sendDataToESP32('B:' + val));
            setupSlider('volumeSlider', 'volumeValue', '%', (val) => val * 10, (val) => sendDataToESP32('V:' + (val * 10)));
            setupSlider('difficultySlider', 'difficultyLevelStr', '', (val) => getDifficultyString(val), (val) => sendDataToESP32('D:' + val));

            // Slider buttons
            setupSliderButtons('brightnessSlider', 'btnBrightnessMinus', 'btnBrightnessPlus', 5, (val) => sendDataToESP32('B:' + val));
            setupSliderButtons('volumeSlider', 'btnVolumeMinus', 'btnVolumePlus', 1, (val) => sendDataToESP32('V:' + (val * 10)));
        }

        function showApp() {
            connectScreen.classList.remove('active');
            dashboardScreen.classList.add('active');
            tabBar.classList.remove('hidden');

            // Reset tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-target="dashboardScreen"]').classList.add('active');
        }

        function showConnectScreen() {
            dashboardScreen.classList.remove('active');
            settingsScreen.classList.remove('active');
            tabBar.classList.add('hidden');
            connectScreen.classList.add('active');
            statusText.textContent = "搜索 Pixel War 设备...";
        }

        function switchTab(targetId, activeBtn) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            activeBtn.classList.add('active');

            // Update screens
            dashboardScreen.classList.remove('active');
            gamesScreen.classList.remove('active');
            settingsScreen.classList.remove('active');
            document.getElementById(targetId).classList.add('active');
        }

        function setupSlider(sliderId, valueId, suffix, transformFn = null, changeCallback = null) {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(valueId);

            // oninput fires continuously as slider moves
            slider.addEventListener('input', (e) => {
                let val = e.target.value;
                if (transformFn) val = transformFn(val);
                valueDisplay.textContent = val + suffix;
            });

            // onchange fires only when dragging stops, to avoid flooding BLE
            if (changeCallback) {
                slider.addEventListener('change', (e) => {
                    changeCallback(e.target.value);
                });
            }
        }

        function setupSliderButtons(sliderId, minusId, plusId, step, changeCallback) {
            const slider = document.getElementById(sliderId);

            document.getElementById(minusId).addEventListener('click', () => {
                slider.value = Math.max(parseInt(slider.min), parseInt(slider.value) - step);
                slider.dispatchEvent(new Event('input'));
                if (changeCallback) changeCallback(slider.value);
            });

            document.getElementById(plusId).addEventListener('click', () => {
                slider.value = Math.min(parseInt(slider.max), parseInt(slider.value) + step);
                slider.dispatchEvent(new Event('input'));
                if (changeCallback) changeCallback(slider.value);
            });
        }

        function getDifficultyString(level) {
            if (level <= 4) return "简单 (Level " + level + ")";
            if (level <= 9) return "中等 (Level " + level + ")";
            if (level <= 13) return "困难 (Level " + level + ")";
            return "极难 (Level " + level + ")";
        }

        function updatePauseUI(isPaused) {
            const btn = document.getElementById('btnStopGame');
            const span = btn.querySelector('span');
            if (isPaused === 1) {
                btn.classList.remove('btn-danger-outline');
                btn.classList.add('btn-primary');
                span.textContent = "恢复游戏";
            } else {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-danger-outline');
                span.textContent = "暂停游戏";
            }
        }

        function updateDemoUI(isDemo) {
            const btn = document.getElementById('btnRunDemo');
            const span = btn.querySelector('span');
            if (isDemo === 1) {
                btn.classList.remove('btn-surface');
                btn.classList.add('btn-primary');
                span.textContent = "结束演示";
            } else {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-surface');
                span.textContent = "运行演示";
            }
        }

        function updateActiveGameUI(modeId) {
            const titleEl = document.getElementById('activeGameTitle');
            const descEl = document.getElementById('activeGameDesc');

            if (modeId === 0) {
                titleEl.textContent = "光线消消乐";
                descEl.textContent = "按颜色消除向你逼近的敌人，撑到最后即可过关。";
            } else {
                titleEl.textContent = "未知应用 (" + modeId + ")";
                descEl.textContent = "无法识别的程序正在运行。";
            }

            // 更新游戏库中的按钮高亮状态
            document.querySelectorAll('.game-card').forEach(card => {
                const cardMode = parseInt(card.dataset.mode);
                const btn = card.querySelector('.launch-btn');
                if (!btn) return;

                const btnText = btn.querySelector('.launch-btn-text');

                if (cardMode === modeId) {
                    btn.classList.remove('btn-surface');
                    btn.classList.add('btn-primary');
                    btn.disabled = true; // 禁止重复启动
                    btnText.textContent = "正在运行";
                } else {
                    btn.classList.add('btn-surface');
                    btn.classList.remove('btn-primary');
                    btn.disabled = false;
                    btnText.textContent = "启动此应用";
                }
            });
        }

        function updateMockData() {
            // Populate some initial blank values, they will be overwritten by BLE
            document.getElementById('scoreValue').textContent = "---";
            document.getElementById('killsValue').textContent = "---";
            document.getElementById('currentLevelValue').textContent = "---";
            document.getElementById('batteryValue').textContent = "---%";
            document.getElementById('settingsBatteryValue').textContent = "---%";
        }

        // ==========================================
        // BLE 通信核心函数
        // ==========================================
        function onDisconnected() {
            console.log('> Bluetooth Device disconnected');
            isConnected = false;
            bleDevice = null;
            bleServer = null;
            bleService = null;
            txCharacteristic = null;
            rxCharacteristic = null;
            showConnectScreen();
        }

        let bleSendQueue = [];
        let isBleSending = false;

        async function processBleQueue() {
            if (isBleSending || bleSendQueue.length === 0) return;
            isBleSending = true;

            while (bleSendQueue.length > 0) {
                const dataString = bleSendQueue[0];
                try {
                    const encoder = new TextEncoder();
                    await rxCharacteristic.writeValue(encoder.encode(dataString));
                    console.log("[BLE TX] " + dataString);
                    bleSendQueue.shift(); // Success
                } catch (error) {
                    console.error("[BLE TX ERROR]", error);
                    bleSendQueue.shift(); // Drop it so we don't get stuck forever
                }
                // Delay slightly to prevent GATT busy errors when sending rapidly
                await new Promise(r => setTimeout(r, 50));
            }

            isBleSending = false;
        }

        async function sendDataToESP32(dataString) {
            if (!rxCharacteristic) {
                console.warn("[BLE] Not connected to device. Cannot send: " + dataString);
                return;
            }
            bleSendQueue.push(dataString);
            processBleQueue();
        }

        function handleIncomingData(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            const str = decoder.decode(value);

            try {
                const data = JSON.parse(str);

                // 处理硬件发来的初始配置同步
                if (data.type === "sync") {
                    if (data.m !== undefined) {
                        updateActiveGameUI(data.m);
                    }
                    if (data.fw !== undefined) {
                        document.getElementById('fwVersion').textContent = data.fw;
                    }
                    if (data.brt !== undefined) {
                        const s = document.getElementById('brightnessSlider');
                        s.value = data.brt;
                        document.getElementById('brightnessValue').textContent = data.brt + '%';
                    }
                    if (data.vol !== undefined) {
                        const s = document.getElementById('volumeSlider');
                        s.value = Math.round(data.vol / 10);
                        document.getElementById('volumeValue').textContent = data.vol + '%';
                    }
                    if (data.diff !== undefined) {
                        const s = document.getElementById('difficultySlider');
                        s.value = data.diff;
                        document.getElementById('difficultyLevelStr').textContent = getDifficultyString(data.diff);
                    }
                    if (data.p !== undefined) updatePauseUI(data.p);
                    if (data.d !== undefined) updateDemoUI(data.d);
                    return;
                }

                // 处理常规的战况 JSON e.g. {"m":0,"s":12,"k":84,"l":5,"b":100}
                if (data.m !== undefined) updateActiveGameUI(data.m);
                if (data.s !== undefined) document.getElementById('scoreValue').textContent = data.s;
                if (data.k !== undefined) document.getElementById('killsValue').textContent = data.k;
                if (data.l !== undefined) document.getElementById('currentLevelValue').textContent = "等级 " + data.l;
                if (data.b !== undefined) {
                    document.getElementById('batteryValue').textContent = data.b + "%";
                    document.getElementById('settingsBatteryValue').textContent = data.b + "%";
                }
                if (data.p !== undefined) updatePauseUI(data.p);
                if (data.d !== undefined) updateDemoUI(data.d);
            } catch (err) {
                console.log("[BLE RX TEXT] " + str); // Not JSON
            }
        }

        // Start
        init();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('SW registered with scope:', registration.scope);
                    })
                    .catch(err => {
                        console.error('SW registration failed:', err);
                    });
            });
        }
    </script>
    <script>
        lucide.createIcons();
    </script>
</body>

</html>